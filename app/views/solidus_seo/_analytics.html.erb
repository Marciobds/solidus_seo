<%
just_purchased = @order && order_just_completed?(@order)
if ENV.values_at('GOOGLE_TAG_MANAGER_ID', 'GOOGLE_ANALYTICS_ID', 'FACEBOOK_PIXEL_ID', 'PINTEREST_TAG_ID').any? \
   && just_purchased

  shared_order_data = {
    affiliation: current_store.name,
    currency: @order.currency,
    tax: @order.tax_total,
    shipping: @order.ship_total
  }

  purchased_items = @order.line_items.map do |line_item|
    variant = line_item.variant

    next unless variant

    {
      id: variant.sku,
      name: variant.name,
      price: line_item.total,
      variant: variant.options_text,
      quantity: line_item.quantity
    }
  end.compact

end %>

<script>
    window.solidusSeoListener = function (tagName, eventName) {
        var tag = document.querySelector('script[data-tag=' + tagName + ']');
        if(!tag) return;
        tag.dataset.firedEvents = eventName;
    }
</script>

<% if ENV['GOOGLE_TAG_MANAGER_ID'].present? %>

<script type="text/javascript" data-tag="google-tag-manager">
    window.dataLayer = window.dataLayer || [];

    <% if just_purchased %>
        let orderData = Object.assign({}, <%= raw shared_order_data.to_json %>, {
            'id': '<%= j @order.number %>', // Transaction ID. Required for purchases and refunds.
            'revenue': '<%= @order.total %>', // Total transaction value (incl. tax and shipping)
            'coupon': '' // TODO: Add coupon code if present
        });

        window.dataLayer.push({
            'ecommerce': {
                'purchase': {
                    'actionField': orderData,
                    'products': <%= raw purchased_items.to_json %>
                }
            }
        });
        window.solidusSeoListener('google-tag-manager', 'purchase');
    <% end %>

    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','<%= ENV['GOOGLE_TAG_MANAGER_ID'] %>');
</script>

<% elsif ENV['GOOGLE_ANALYTICS_ID'].present? %>

<script async src="https://www.googletagmanager.com/gtag/js?id=<%= ENV['GOOGLE_ANALYTICS_ID'] %>"></script>
<script type="text/javascript" data-tag="google-analytics">
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', '<%= ENV['GOOGLE_ANALYTICS_ID'] %>');

    <% if just_purchased %>
        let purchaseData = Object.assign({}, <%= raw shared_order_data.to_json %>, {
            'transaction_id': '<%= @order.number %>',
            'value': '<%= @order.total %>',
            'items': <%= raw purchased_items.to_json %>
        });

        gtag('event', 'purchase', purchaseData);
        window.solidusSeoListener('google-analytics', 'purchase');
    <% end %>
</script>
<% end %>

<% if ENV['FACEBOOK_PIXEL_ID'].present? %>
<script type="text/javascript" data-tag="facebook">
    !function(f,b,e,v,n,t,s) {
        if (f.fbq) return;
        n = f.fbq = function() { n.callMethod ? n.callMethod.apply(n, arguments) : n.queue.push(arguments) };
        if (!f._fbq) f._fbq=n;
        n.push = n; n.loaded = !0; n.version = '2.0'; n.queue=[]; t = b.createElement(e); t.async = !0; t.src = v;
        s = b.getElementsByTagName(e)[0]; s.parentNode.insertBefore(t, s);
    }(window, document,'script', 'https://connect.facebook.net/en_US/fbevents.js');

    fbq('init', '<%= ENV['FACEBOOK_PIXEL_ID'] %>');
    fbq('track', 'PageView');

    <% if just_purchased %>
        <% items = purchased_items.map { |li| li.slice(:id, :quantity) } %>

        fbq('track', 'Purchase', {
            value: <%= @order.total %>,
            currency: 'USD',
            contents: <%= raw items.to_json %>,
            content_type: 'product',

            // custom properties
            order_number: '<%= @order.number %>',
            item_total: <%= @order.item_total %>,
            tax_total: <%= @order.tax_total %>,
            ship_total: <%= @order.ship_total %>,
            promo_total: <%= @order.promo_total %>,
        });
        window.solidusSeoListener('facebook', 'purchase');
    <% end %>
</script>
<noscript>
    <img height="1" width="1" src="https://www.facebook.com/tr?id=<%= ENV['FACEBOOK_PIXEL_ID'] %>&ev=PageView&noscript=1" />
</noscript>
<% end %>

<% if ENV['PINTEREST_TAG_ID'].present? %>
<script type="text/javascript" data-tag="pinterest">
    !function(e){if(!window.pintrk){window.pintrk=function(){window.pintrk.queue.push(
    Array.prototype.slice.call(arguments))};var
    n=window.pintrk;n.queue=[],n.version="3.0";var
    t=document.createElement("script");t.async=!0,t.src=e;var
    r=document.getElementsByTagName("script")[0];r.parentNode.insertBefore(t,r)}}("https://s.pinimg.com/ct/core.js");
    pintrk('load', '<%= ENV['PINTEREST_TAG_ID'] %>');
    pintrk('page');

    <% if just_purchased %>
        <% items = purchased_items.map do |li|
            {
              product_id: li[:id],
              product_name: li[:name],
              product_quantity: li[:quantity],
              product_price: li[:price],
            }
          end %>

        pintrk('track', 'checkout', {
            value: <%= @order.total %>,
            order_quantity: <%= @order.line_items.sum(&:quantity) %>,
            currency: 'USD',
            line_items: <%= raw items.to_json %>
        });

        window.solidusSeoListener('pinterest', 'purchase');
    <% end %>
 </script>
 <noscript>
   <img height="1" width="1" style="display:none;" alt="" src="https://ct.pinterest.com/v3/?tid=<%= ENV['PINTEREST_TAG_ID'] %>&event=init&noscript=1" />
 </noscript>
<% end %>
